 <!DOCTYPE html>
 <html>
 <title>CROSSFIT</title>
 <head>
 	<meta charset="utf-8" />
 	<!-- Bootstrap core JS-->
 	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
 	<script src="js/jquery.min.js"></script>
 	<script src="js/babylon.js"></script>
 	<script src="js/babylonjs.loaders.min.js"></script>
 	<script src="js/babylon.gui.min.js"></script>

 	<script src="js/howler.min.js"></script>

 	<script src="js/anime.min.js"></script>
 	<style type="text/css">
 		#canvas_od {
 			top: 0;
 			left: 0;
 			width: 100%;
 			height: 100%;
 		}
 	</style>
 </head>
 <body class="objetoDigitalExtensivo" id="EXT21_3_HIS_L1_A_01_OD1">
 	<div id="divCanvas">
 		<canvas id='canvas_od' width="720" height="1280"></canvas>
 	</div>
 	<script>
 		var appInfografico3d=function(_id,_dentroModulo,_itens){
 			window.addEventListener('DOMContentLoaded', function(){
 				let debugador=false;
 				let offsetCamera=60;
 				if(window.innerHeight > window.innerWidth){
 					offsetCamera=60;
 				}
 				let caminho="resources/image/";
 				let zoomObjeto=false;
 				let clique=true;
 				let canvas = document.getElementById("canvas_od");
 				let camera;
 				let distancia=2;
 				let distanciaCria=15;
 				let distApaga=20;
 				let distX=[distancia*5,distancia*4,distancia*3,distancia*2,distancia,0,distancia*-1,distancia*-2,distancia*-3,distancia*-4,distancia*-5];
 				let target;
 				let advancedTexture;
 				let count=0;
 				let countRuas=0;
 				let personagem;
 				let rootPersonagem;
 				let obstaculos=[];
 				let carros=[];
 				let comidas=[];
 				let arvore;
 				let burguer;
 				let rua3x3;
 				let posX=5;
 				let posY=0;
 				let sommastiga = new Howl({
 					src: ['resources/image/bite.mp3']
 				});

 				let map=[
 				]

 				let engine = new BABYLON.Engine(canvas, true);

 				let createScene = function(){
 					scene = new BABYLON.Scene(engine);
 					scene.clearColor = new BABYLON.Color3.FromHexString("#83A243");
 					scene.ambientColor = BABYLON.Color3.White();

 					camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, new BABYLON.Vector3(0, 0, 0), scene);

 					camera.setPosition(new BABYLON.Vector3(65, 65, -65));

 					target = new BABYLON.TransformNode('target', scene);

 					camera.fov = 0.5;
 					camera.pinchDeltaPercentage = 0.01;
 					camera.wheelDeltaPercentage = 0.01;



 					light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);
 					light2 = new BABYLON.DirectionalLight("dir01", new BABYLON.Vector3(-0.8, -0.8, -1.0), scene);
 					light2.position = new BABYLON.Vector3(0, 10, 0);
 					light.intensity = 0.6;
 					light2.intensity = 2;
 					light2.shadowMinZ = 1;
 					light2.shadowMaxZ = 5000;


 					var shadowGenerator = new BABYLON.ShadowGenerator(1024, light2);
 					shadowGenerator.usePoissonSampling = true;
 					shadowGenerator.useBlurExponentialShadowMap = true;

 					var grupo1 = new BABYLON.TransformNode();


 					var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

 					var text1 = new BABYLON.GUI.TextBlock();
 					text1.text = "REGY CROSSFIT";
 					text1.color = "white";
 					text1.fontSize = 35;
 					text1.top="-45%";
 					advancedTexture.addControl(text1); 

 					var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "frente");
 					button1.width = "150px"
 					button1.height = "100px";
 					button1.color = "white";
 					button1.cornerRadius = 20;
 					button1.background = "green";
 					button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
 					button1.onPointerUpObservable.add(function() {
 						if(clique){
 							
 							clique=false;
 							setTimeout(function(){
 								clique=true
 							},100)
 							let passa=true;
 							let posProjetada=rootPersonagem.getAbsolutePosition();
 							posProjetada.z=posProjetada.z+distancia;
 							//console.log("posX "+posX+" posY "+posY+ "  "+map[posY][posX]);
 							if(map[posY+1][posX]!=1){
 								posY+=1;

 								//rootPersonagem.position.z=posY*distancia;
 								if(count-posY<distanciaCria){
 									verificaCriaRua();
 								}
 								deletaObjetos();
 								anime({
 									targets: rootPersonagem.position,
 									z:posY*distancia,
 									easing: 'easeOutBack',
 									duration: 100,
 									complete: () => {
 										
 									}
 								})
 								anime({
 									targets: personagem.position,
 									keyframes: [
 									{y: 1},
 									{y: 0}
 									],
 									easing: 'easeOutBack',
 									duration: 100
 								})
 								anime({
 									targets: personagem.rotation,
 									y: Math.PI / 1,
 									easing: 'easeOutBack',
 									duration: 100
 								})
 								//personagem.rotation = new BABYLON.Vector3(0, Math.PI / 1, 0);
 								//personagem.rotation.z=Math.PI / 1.5;
 							}
 						}
 					});
 					advancedTexture.addControl(button1); 

 					var button2 = BABYLON.GUI.Button.CreateSimpleButton("but2", "<");
 					button2.width = "150px"
 					button2.lef = "150px"
 					button2.height = "100px";
 					button2.color = "white";
 					button2.cornerRadius = 20;
 					button2.background = "green";
 					button2.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
 					button2.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
 					button2.onPointerUpObservable.add(function() {
 						if(clique){
 							console.log("clica:");
 							clique=false;
 							setTimeout(function(){
 								clique=true
 							},50)
 							let passa=true;
 							let posProjetada=rootPersonagem.getAbsolutePosition();
 							posProjetada.x=posProjetada.x+distancia;
 							
 							if(map[posY][posX-1]!=1){
 								if(posX>0){
 									posX-=1;
 									//rootPersonagem.position.x=distX[posX];
 									anime({
 										targets: rootPersonagem.position,
 										x:distX[posX],
 										easing: 'easeOutBack',
 										duration: 100,
 										complete: () => {

 										}
 									})
 									anime({
 										targets: personagem.position,
 										keyframes: [
 										{y: 1},
 										{y: 0}
 										],
 										easing: 'easeOutBack',
 										duration: 100
 									})
 									anime({
 										targets: personagem.rotation,
 										y: -Math.PI/2,
 										easing: 'easeOutBack',
 										duration: 100
 									})
 								}

 							}
 						}
 					});
 					advancedTexture.addControl(button2); 
 					var button3 = BABYLON.GUI.Button.CreateSimpleButton("but2", ">");
 					button3.width = "150px"
 					button3.lef = "150px"
 					button3.height = "100px";
 					button3.color = "white";
 					button3.cornerRadius = 20;
 					button3.background = "green";
 					button3.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
 					button3.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
 					button3.onPointerUpObservable.add(function() {
 						if(clique){
 							console.log("clica:");
 							clique=false;
 							setTimeout(function(){
 								clique=true
 							},50)
 							let passa=true;
 							let posProjetada=rootPersonagem.getAbsolutePosition();
 							posProjetada.x=posProjetada.x-distancia;
 							if(map[posY][posX+1]!=1){
 								if(posX<10){
 									posX+=1;
 									//rootPersonagem.position.x=distX[posX];

 									anime({
 										targets: rootPersonagem.position,
 										x:distX[posX],
 										easing: 'easeOutBack',
 										duration: 100,
 										complete: () => {

 										}
 									})
 									anime({
 										targets: personagem.position,
 										keyframes: [
 										{y: 1},
 										{y: 0}
 										],
 										easing: 'easeOutBack',
 										duration: 100
 									})
 									anime({
 										targets: personagem.rotation,
 										y: Math.PI/2,
 										easing: 'easeOutBack',
 										duration: 100
 									})
 								}

 							}
 						}
 					});
 					advancedTexture.addControl(button3);   


 					var assetsManager = new BABYLON.AssetsManager(scene);

 					let meshTaskcenario = assetsManager.addMeshTask("cenario", "", caminho, "cenario.glb");
 					let meshTaskPersonagem = assetsManager.addMeshTask("personagem", "", caminho, "bob.glb");
 					for (var i = 0; i <_itens.length; i++) {
 						let meshComidas = assetsManager.addMeshTask("comidas", "", caminho, _itens[i].obj);
 					}
 					assetsManager.onFinish = function (tasks) {

 						for (let j = 0; j < tasks.length; j++) {
 							if (tasks[j].name == "comidas") {
 								const task = tasks[j];
 								for (let i = 0; i < task.loadedMeshes.length; i++) {
 									if(task.loadedMeshes[i].name.includes("item")){
 										let _comida=task.loadedMeshes[i];
 										_comida.isVisible=false;
 										_comida.parent = null;
 										//_comida.scaling=new BABYLON.Vector3(_itens[i].size,_itens[i].size,_itens[i].size);
 										comidas.push(_comida)
 									}
 								}
 							}
 						}
 						for (let j = 0; j < tasks.length; j++) {
 							if (tasks[j].name == "personagem") {
 								const task = tasks[j];
 								for (let i = 0; i < task.loadedMeshes.length; i++) {
 									if(task.loadedMeshes[i].name=="personagem"){
 										personagem=task.loadedMeshes[i];
 										task.loadedMeshes[i].checkCollisions = true;
 										personagem.rotation = new BABYLON.Vector3(0, 0, 0);
 									}
 									if(task.loadedMeshes[i].name=="rootPersonagem"){
 										rootPersonagem=task.loadedMeshes[i];
 									}
 								}
 							}
 							if (tasks[j].name == "cenario") {
 								const task = tasks[j];
 								for (let i = 0; i < task.loadedMeshes.length; i++) {
 									task.loadedMeshes[i].isPickable = false;
 									task.loadedMeshes[i].pode = true;
 									if(task.loadedMeshes[i].name.includes("obstaculo")){
 									}
 									if(task.loadedMeshes[i].name=="cenario"){
 										task.loadedMeshes[i].isVisible=false;

 									}
 									if(task.loadedMeshes[i].name=="rua3x3"){
 										rua3x3=task.loadedMeshes[i];
 										rua3x3.isVisible=false;
 										rua3x3.parent = null

 									}
 									if(task.loadedMeshes[i].name=="tree_blocks"){

 										arvore=task.loadedMeshes[i];
 										arvore.isVisible=false;
 										arvore.parent = null
 									}
 									
 								}

 							}
 						}

 						for (let i=0;i < 20; i++) {
 							criaFileira();
 						}
 						console.log(JSON.stringify(map))

 					}	
 					assetsManager.load();
 					scene.onBeforeCameraRenderObservable.add(()=>{
 						//camera.setTarget(target.position)
 						if(rootPersonagem){
 							let camTargetTo = new BABYLON.Vector3(rootPersonagem.position.x*-1, rootPersonagem.position.y + 2, rootPersonagem.position.z);
 							camera.target = BABYLON.Vector3.Lerp(camera.target, camTargetTo, 0.025);
 							let camPosTo = new BABYLON.Vector3(rootPersonagem.position.x*-1 + 15, rootPersonagem.position.y + 50, rootPersonagem.position.z - 35);
 							camera.position = BABYLON.Vector3.Lerp(camera.position, camPosTo, 0.025);
 							for (var i = 0; i < carros.length; i++) {
 								if (personagem.intersectsMesh(carros[i], false)) {
 									console.log("colidiu");
 									carros[i].dispose();
 									carros.splice(i, 1); 
 									sommastiga.play();
 								}
 								
 							}
 						}
 						
 					})
 					return scene;
 				}


 				scene = createScene();
 				scene.onPointerDown = function (evt, pickResult) {
 					if (pickResult.hit) {
 						if(pickResult.pickedMesh.name=="personagem" ){
 							console.log(pickResult.pickedMesh.name);

 						}
 					}
 				};
 				function deletaObjetos(){
 					for (var i = 0; i < obstaculos.length; i++) {
 						if((personagem.getAbsolutePosition().z-obstaculos[i].getAbsolutePosition().z)>distApaga){
 							obstaculos[i].dispose();
 							obstaculos.splice(i, 1); 
 						}
 					}
 					for (var i = 0; i < carros.length; i++) {
 						if((personagem.getAbsolutePosition().z-carros[i].getAbsolutePosition().z)>distApaga){
 							carros[i].dispose();
 							carros.splice(i, 1); 
 						}
 					}
 					console.log("carros"+carros.length);
 				}
 				function verificaCriaRua(){
 					countRuas++;
 					
 					let randomizacaoRua=Math.round(Math.random()*15)+1;
 					if(countRuas>randomizacaoRua){
 						countRuas=0;
 						criaRua();
 					}else{
 						criaFileira();
 					}
 				}
 				function criaRua(){
 					const ruanova = rua3x3.clone("rua");
 					ruanova.isVisible=true;
 					ruanova.position.z=count*distancia;
 					obstaculos.push(ruanova);
 					let w=0;
 					for (var i = 0; i < 3; i++) {
 						let velocidade=Math.round(Math.random()*5000)+2000;
 						for (var j = 0; j < 3; j++) {
 							let _comida = comidas[Math.floor(Math.random() * comidas.length)];
 							const carro = _comida.clone("comida");
 							carro.isVisible=true;
 							let dest;
 							if(w==0){
 								carro.position.x=-30;
 								dest=30;
 								w=1;
 							}else{
 								carro.position.x=30;
 								dest=-30;
 								w=0;
 							}
 							carro.position.z=count*distancia;
 							anime({
 								targets: carro.position,
 								x:dest,
 								loop:true,
 								easing: 'linear',
 								delay:(velocidade/3)*j,
 								duration: velocidade
 							})
 							carros.push(carro);
 						}


 						criaFileira(true);
 					}

 				}
 				function criaFileira(_rua=false){

 					let rand=[];
 					for (var i = 0; i < 10; i++) {
 						let num;
 						if(_rua){
 							num=0;
 						}else if(count<3){
 							num=0;
 						}else{
 							num=Math.round(Math.random()*10);
 						}
 						rand.push(num);
 						if(num==1){
 							const box2 = arvore.clone("arvore");
 							box2.isVisible=true;
/*
 							const box = BABYLON.MeshBuilder.CreateBox("box", {height: 0.2, width: distancia, depth: distancia});
 							box.position.x=i*distancia-(5*distancia);
 							box.position.z=count*distancia;
 							*/
 							box2.position.x=i*distancia-(5*distancia);
 							box2.position.z=count*distancia;
 							obstaculos.push(box2);
 						}
 					}
 					map.push(rand);
 					count++;
 				}
 				function checkme_xyz(a, b) {
 					if(map[posX][posY]){

 					}


 				}
 				engine.runRenderLoop(function(){
 					scene.render();

 				});

 				window.addEventListener('resize', redimensionaGame, false);


 				function redimensionaGame() {
 					resizeGame();
 					engine.resize();
 					

 				}
 				engine.resize();

 			});

}
let comidas=[{obj:"hotdog.glb",size:1},{obj:"bolo.glb",size:2}];
appInfografico3d("od1",false,comidas);

</script>

<script type="text/javascript">
	
	var orientacao;
	var widthToHeight = 9 / 16;
	var newWidth = window.innerWidth;
	var newHeight = window.innerHeight;
	var newWidthToHeight = newWidth / newHeight;
	let canvas = document.getElementById("canvas_od");
	let divcanvas = document.getElementById("divCanvas");
	newWidth = newHeight * widthToHeight;
	divcanvas.style.width = newWidth + 'px';
	divcanvas.style.height = newHeight + 'px';
	divcanvas.style.marginLeft = (window.innerWidth-newWidth)/2 + 'px';
	divcanvas.style.marginTop = (window.innerHeight-newHeight)/2 + 'px';
	function resizeGame() {
		var newWidth = window.innerWidth;
		var newHeight = window.innerHeight;
		widthToHeight = 9 / 16;
		orientacao=1; 

		newWidth = newHeight * widthToHeight;
		divcanvas.style.width = newWidth + 'px';
		divcanvas.style.height = '100%';
		divcanvas.style.marginLeft = (window.innerWidth-newWidth)/2 + 'px';
		divcanvas.style.marginTop = (window.innerHeight-newHeight)/2 + 'px';
	}
</script>
</body>
</html> 